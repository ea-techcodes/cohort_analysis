{"datasets":[{"name":"4f2aafe1","displayName":"Retention Rate By Cohort","query":"/*\nThis query calculates the retention rates for 1, 2, and 3 months based on the time between first and second purchases.\n*/\n\nWITH months AS (           -- Grouping customers by the month of their first and second purchases using cohort_analysis table\n  SELECT\n    customer_id\n    ,DATE(DATE_TRUNC('MONTH', first_purchase)) AS first_month\n    ,DATE(DATE_TRUNC('MONTH', second_purchase)) AS second_month\n  FROM \n    cohort_analysis\n),\n\ntt AS (                    -- Calculated the number of months between first and second purchases\n  SELECT\n    customer_id\n    ,first_month AS month_group\n    ,MONTHS_BETWEEN(second_month, first_month) AS months_between\n  FROM \n    months\n)\n\n-- Final selection calculates the retention rates for 1, 2, and 3 months based on the time between the first and second purchases using CASE statements.\nSELECT\n  month_group\n  ,COUNT(DISTINCT customer_id) AS total_customers\n  ,ROUND(COUNT(DISTINCT CASE WHEN months_between <= 1 THEN customer_id ELSE NULL END) / COUNT(DISTINCT customer_id), 2) AS retention_rate_1m\n  ,ROUND(COUNT(DISTINCT CASE WHEN months_between <= 2 THEN customer_id ELSE NULL END) / COUNT(DISTINCT customer_id), 2) AS retention_rate_2m\n  ,ROUND(COUNT(DISTINCT CASE WHEN months_between <= 3 THEN customer_id ELSE NULL END) / COUNT(DISTINCT customer_id), 2) AS retention_rate_3m\nFROM \n  tt\nGROUP BY \n  month_group\nORDER BY \n  month_group\n;"},{"name":"859a0c9d","displayName":"REPEAT PURCHASE RATE","query":"USE CATALOG `workspace`;\nUSE SCHEMA `default`;\n\nWITH fp_and_orders AS (  \nSELECT\n  customer_id\n  ,MIN(DATE_TRUNC('MONTH', order_date)) AS first_purchase\n  ,COUNT(order_id) AS order_count\nFROM\n  bigquery_db_cohort_db.ecom_orders\nGROUP BY 1\n)\n\nSELECT    \n  first_purchase AS purchase_month\n  ,ROUND(COUNT(CASE WHEN order_count >= 2 THEN customer_id END) / COUNT(DISTINCT customer_id), 2) AS repeat_rate_2nd_order\n  ,ROUND(COUNT(CASE WHEN order_count >= 3 THEN customer_id END) / COUNT(DISTINCT customer_id), 2) AS repeat_rate_3rd_order\n  ,ROUND(COUNT(CASE WHEN order_count >= 4 THEN customer_id END) / COUNT(DISTINCT customer_id), 2) AS repeat_rate_4th_order\nFROM\n  fp_and_orders\nGROUP BY\n  purchase_month\nORDER BY\n  purchase_month\n;"},{"name":"e5b9befd","displayName":"COHORT SIZE BY MONTH","query":"USE CATALOG `workspace`;\nUSE SCHEMA `default`;\n\nWITH first_purchase AS (        \n  SELECT\n    customer_id\n    ,DATE(MIN(DATE_TRUNC('MONTH', order_date))) AS first_purchase_date\n  FROM\n    bigquery_db_cohort_db.ecom_orders\n  GROUP BY customer_id\n)\n\nSELECT                          \n  first_purchase_date AS cohort_month\n  ,COUNT(customer_id) AS cohort_size\nFROM \n  first_purchase\nGROUP BY \n  cohort_month\nORDER BY \n  cohort_month\n;"}],"pages":[{"name":"25070f0c","displayName":"Retention Rate by Cohort","layout":[{"widget":{"name":"119ce449","queries":[{"name":"main_query","query":{"datasetName":"4f2aafe1","fields":[{"name":"monthly(month_group)","expression":"DATE_TRUNC(\"MONTH\", `month_group`)"},{"name":"avg(retention_rate_1m)","expression":"AVG(`retention_rate_1m`)"},{"name":"avg(retention_rate_2m)","expression":"AVG(`retention_rate_2m`)"},{"name":"avg(retention_rate_3m)","expression":"AVG(`retention_rate_3m`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"line","encodings":{"x":{"fieldName":"monthly(month_group)","scale":{"type":"temporal"},"axis":{"title":" ","hideLabels":false,"hideTitle":false},"displayName":" "},"y":{"fields":[{"fieldName":"avg(retention_rate_1m)","displayName":"Retention Rate 1M"},{"fieldName":"avg(retention_rate_2m)","displayName":"Retention Rate 2M"},{"fieldName":"avg(retention_rate_3m)","displayName":"Retention Rate 3M"}],"scale":{"type":"quantitative"},"axis":{"title":"Retention Rate"}}},"frame":{"title":"RETENTION RATES BY COHORT","showTitle":true}}},"position":{"x":0,"y":0,"width":6,"height":6}},{"widget":{"name":"0c16e705","queries":[{"name":"efd331924a8847469e8b072f8fc31c19","query":{"datasetName":"859a0c9d","fields":[{"name":"purchase_month","expression":"`purchase_month`"},{"name":"column_3ef8bb8f1117","expression":"SUM(`repeat_rate_2nd_order`)"},{"name":"column_3ef8bb8f1120","expression":"SUM(`repeat_rate_3rd_order`)"},{"name":"column_3ef8bb8f1123","expression":"SUM(`repeat_rate_4th_order`)"}],"disaggregated":false}}],"spec":{"version":0,"viz_spec":{"display_name":"REPEAT ORDERS","description":"","viz_type":"CHART","serialized_options":"{\"version\":2,\"globalSeriesType\":\"column\",\"sortX\":true,\"sortY\":true,\"legend\":{\"traceorder\":\"normal\"},\"xAxis\":{\"type\":\"-\",\"labels\":{\"enabled\":true},\"title\":{\"text\":\" \"}},\"yAxis\":[{\"type\":\"-\",\"title\":{\"text\":\"REPEAT ORDERS RATES\"}},{\"type\":\"-\",\"opposite\":true}],\"alignYAxesAtZero\":true,\"error_y\":{\"type\":\"data\",\"visible\":true},\"series\":{\"stacking\":null,\"error_y\":{\"type\":\"data\",\"visible\":true}},\"seriesOptions\":{\"column_3ef8bb8f1073\":{\"yAxis\":0,\"type\":\"column\"},\"column_3ef8bb8f1076\":{\"yAxis\":0,\"type\":\"column\"},\"column_3ef8bb8f1079\":{\"yAxis\":0,\"type\":\"column\"},\"column_3ef8bb8f1117\":{\"yAxis\":0,\"type\":\"column\",\"name\":\"2ND ORDER\",\"color\":\"#99DDB4\"},\"column_3ef8bb8f1120\":{\"yAxis\":0,\"type\":\"column\",\"name\":\"3RD ORDER\",\"color\":\"#FCA4A1\"},\"column_3ef8bb8f1123\":{\"yAxis\":0,\"type\":\"column\",\"name\":\"4TH ORDER\",\"color\":\"#8BCAE7\"}},\"valuesOptions\":{},\"direction\":{\"type\":\"counterclockwise\"},\"sizemode\":\"diameter\",\"coefficient\":1,\"numberFormat\":\"0,0.[00000]\",\"percentFormat\":\"0[.]00%\",\"textFormat\":\"\",\"missingValuesAsZero\":true,\"useAggregationsUi\":true,\"swappedAxes\":false,\"dateTimeFormat\":\"YYYY-MM-DD HH:mm\",\"showDataLabels\":false,\"columnConfigurationMap\":{\"x\":{\"column\":\"purchase_month\",\"id\":\"column_3ef8bb8f1066\"},\"y\":[{\"id\":\"column_3ef8bb8f1117\",\"column\":\"repeat_rate_2nd_order\",\"transform\":\"SUM\"},{\"id\":\"column_3ef8bb8f1120\",\"column\":\"repeat_rate_3rd_order\",\"transform\":\"SUM\"},{\"id\":\"column_3ef8bb8f1123\",\"column\":\"repeat_rate_4th_order\",\"transform\":\"SUM\"}]},\"isAggregationOn\":true,\"condensed\":true,\"withRowNumber\":true}","query_name":"efd331924a8847469e8b072f8fc31c19"}}},"position":{"x":0,"y":6,"width":3,"height":6}},{"widget":{"name":"577290c1","queries":[{"name":"16114246ed0f499781375f91c09d7dc8","query":{"datasetName":"e5b9befd","fields":[{"name":"column_3ef8bb8f1784","expression":"DATE_TRUNC(\"MONTH\", `cohort_month`)"},{"name":"column_3ef8bb8f1778","expression":"AVG(`cohort_size`)"}],"disaggregated":false}}],"spec":{"version":0,"viz_spec":{"display_name":"COHORT BY MONTH","description":"","viz_type":"CHART","serialized_options":"{\"version\":2,\"globalSeriesType\":\"column\",\"sortX\":true,\"sortY\":true,\"legend\":{\"traceorder\":\"normal\"},\"xAxis\":{\"type\":\"-\",\"labels\":{\"enabled\":true},\"title\":{\"text\":\" \"}},\"yAxis\":[{\"type\":\"-\",\"title\":{\"text\":\"COHORT SIZE\"}},{\"type\":\"-\",\"opposite\":true}],\"alignYAxesAtZero\":true,\"error_y\":{\"type\":\"data\",\"visible\":true},\"series\":{\"stacking\":null,\"error_y\":{\"type\":\"data\",\"visible\":true}},\"seriesOptions\":{\"column_3ef8bb8f1778\":{\"name\":\"cohort_size\",\"yAxis\":0,\"type\":\"column\",\"color\":\"#00A972\"}},\"valuesOptions\":{},\"direction\":{\"type\":\"counterclockwise\"},\"sizemode\":\"diameter\",\"coefficient\":1,\"numberFormat\":\"0,0.[00000]\",\"percentFormat\":\"0[.]00%\",\"textFormat\":\"\",\"missingValuesAsZero\":true,\"useAggregationsUi\":true,\"swappedAxes\":false,\"dateTimeFormat\":\"YYYY-MM-DD HH:mm\",\"showDataLabels\":false,\"columnConfigurationMap\":{\"x\":{\"column\":\"cohort_month\",\"transform\":\"MONTH_LEVEL\",\"id\":\"column_3ef8bb8f1784\"},\"y\":[{\"column\":\"cohort_size\",\"transform\":\"AVG\",\"id\":\"column_3ef8bb8f1778\"}]},\"isAggregationOn\":true,\"condensed\":true,\"withRowNumber\":true}","query_name":"16114246ed0f499781375f91c09d7dc8"}}},"position":{"x":3,"y":6,"width":3,"height":6}}]}]}